name: Update Worker

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # 每6小时运行一次

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检查仓库
        uses: actions/checkout@v3

      - name: 删除旧文件
        run: |
          rm -rf ./*

      - name: 下载并解压 BPB-Worker-Panel
        run: |
          curl -L https://github.com/xyTom/bpb-worker-panel/archive/refs/heads/main.zip -o main.zip
          unzip -o main.zip
          mv bpb-worker-panel-main/* ./
          rm -rf bpb-worker-panel-main main.zip

      # 🔥 自动打补丁：在 _worker.js 开头插入 getIPList() 逻辑
      - name: 给 _worker.js 打补丁（添加 ip.txt 读取功能）
        run: |
          if [ -f "_worker.js" ]; then
            cat << 'EOF' > patch.js
// ====== 自动读取 ip.txt 功能开始 ======
async function getIPList() {
  try {
    let resp = await fetch("https://private.zzjay.pp.ua/ip.txt");
    let text = await resp.text();
    return text.split("\n").filter(line => line.trim() !== "");
  } catch (e) {
    return [];
  }
}
// ====== 自动读取 ip.txt 功能结束 ======
EOF
            cat patch.js _worker.js > _worker.js.new
            mv _worker.js.new _worker.js
          fi

      - name: 提交更改到仓库
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "自动更新 Worker 代码并添加 ip.txt 读取功能" || echo "No changes to commit"
          git push
